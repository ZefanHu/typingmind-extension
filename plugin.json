{
    "id": "gpt_image_editor_with_chevereto",
    "org": null,
    "code": "async function gpt_image_editor(params, userSettings, authorizedResources) {\n  const prompt = params.prompt;\n  const openaikey = userSettings.openaikey;\n  const quality = userSettings.quality || 'auto';\n  const resolution = userSettings.resolution || 'auto';\n  const background = userSettings.background || 'auto';\n  const base_url = userSettings.base_url || 'https://api.openai.com';\n  \n  if (!openaikey) {\n    throw new Error(\n      'No OpenAI key provided to the DALL-3 plugin. Please enter your OpenAI key in the plugin settings seperately and try again.',\n    );\n  }\n  \n  let resultBase64;\n  const content = authorizedResources?.lastUserMessage?.content || [];\n  let attachedImages = content\n    .filter((item) => item.type === 'tm_image_file')\n    .map((c) => ({\n      url: c.sync?.url || c.metadata?.base64,\n      name: c.metadata?.name,\n    }));\n  const lastToolCallCards =\n    authorizedResources?.lastSameToolCallResponse?.cards;\n  if (!attachedImages.length && Array.isArray(lastToolCallCards)) {\n    attachedImages = lastToolCallCards\n      .filter((c) => c.type === 'image')\n      .map((c) => ({\n        url: c.image.url,\n        name: 'output.png', // no name provided for tool output\n      }));\n  }\n  const mode = attachedImages.length ? 'edit' : 'create';\n  if (mode === 'create') {\n    const body = {\n      model: 'gpt-image-1',\n      prompt: prompt,\n      n: 1,\n      size: resolution,\n      quality: quality,\n      output_format: 'png',\n      background: background,\n    };\n    const requestOptions = {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: 'Bearer ' + openaikey,\n      },\n      body: JSON.stringify(body),\n    };\n    let response = await fetch(\n      `${base_url}/v1/images/generations`,\n      requestOptions,\n    );\n    if (response.status === 401) {\n      throw new Error('Invalid API Key. Please check your settings.');\n    }\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(errorText);\n    }\n    let data = await response.json();\n    resultBase64 = data.data[0].b64_json;\n  } else if (mode === 'edit') {\n    const imagesAsBlobs = await Promise.all(\n      attachedImages.map(async ({ url, name }) => {\n        if (url.startsWith('data:image/')) {\n          const blob = await fetch(url).then((res) => res.blob());\n          return { blob, name };\n        }\n        const response = await fetch(url);\n        const blob = await response.blob();\n        return { blob, name };\n      }),\n    );\n    const formData = new FormData();\n    // Model and prompt are simple\n    formData.append('model', 'gpt-image-1');\n    formData.append('prompt', prompt);\n    formData.append('n', 1);\n    formData.append('size', resolution);\n    formData.append('quality', quality);\n    formData.append('output_format', 'png');\n    formData.append('background', background);\n    // Load images (from URLs) and append as Blobs\n    for (const { blob, name } of imagesAsBlobs) {\n      formData.append('image[]', blob, name);\n    }\n    // Call the API\n    const response = await fetch(`${base_url}/v1/images/edits`, {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${openaikey}`,\n      },\n      body: formData,\n    });\n    if (!response.ok) {\n      const err = await response.text();\n      throw new Error(`API error: ${err}`);\n    }\n    const result = await response.json();\n    // Decode base64 and save as image (browser code varies; see below)\n    resultBase64 = result.data[0].b64_json;\n  } else {\n    throw new Error('Invalid mode. Please use \\\"create\\\" or \\\"edit\\\".');\n  }\n\n  // --- å¼€å§‹ä¿®æ”¹ï¼šæ·»åŠ  Chevereto ä¸Šä¼ é€»è¾‘ ---\n  let finalImageUrl = 'data:image/png;base64,' + resultBase64; // é»˜è®¤æ˜¯ data URL\n  let syncImage = true; // é»˜è®¤è®© TypingMind åŒæ­¥\n\n  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é…ç½®äº† Chevereto\n  if (userSettings.cheveretoUrl && userSettings.cheveretoApiKey) {\n    console.log(\"æ£€æµ‹åˆ° Chevereto é…ç½®ï¼Œå°è¯•ä¸Šä¼ ...\"); // è°ƒè¯•ä¿¡æ¯\n    try {\n      const cheveretoApiUrl = userSettings.cheveretoUrl;\n      const cheveretoApiKey = userSettings.cheveretoApiKey;\n\n      // Chevereto API v1 éœ€è¦ FormData\n      const formData = new FormData();\n      formData.append('key', cheveretoApiKey);\n      // ä½¿ç”¨ 'source' å‚æ•°ç›´æŽ¥ä¼ é€’ base64 æ•°æ®\n      formData.append('source', resultBase64);\n      // è¦æ±‚è¿”å›ž JSON æ ¼å¼ï¼Œæ–¹ä¾¿è§£æž\n      formData.append('format', 'json');\n\n      const uploadResponse = await fetch(cheveretoApiUrl, {\n        method: 'POST',\n        body: formData,\n        // é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® Content-Type header for FormData\n      });\n\n      if (!uploadResponse.ok) {\n        // ä¸Šä¼ å¤±è´¥ï¼Œè®°å½•é”™è¯¯ï¼Œä½†ä»ç„¶ä½¿ç”¨é»˜è®¤çš„ data URL\n        const errorText = await uploadResponse.text();\n        console.error(`Chevereto ä¸Šä¼ å¤±è´¥: ${uploadResponse.status} - ${errorText}`);\n        // å¯ä»¥é€‰æ‹©åœ¨è¿™é‡ŒæŠ›å‡ºé”™è¯¯: throw new Error(`Chevereto upload failed: ${errorText}`);\n      } else {\n        // ä¸Šä¼ æˆåŠŸï¼Œè§£æžè¿”å›žçš„ JSON\n        const result = await uploadResponse.json();\n        if (result.status_code === 200 && result.image && result.image.url) {\n          // èŽ·å–åˆ° Chevereto è¿”å›žçš„å›¾ç‰‡ URL\n          finalImageUrl = result.image.url;\n          syncImage = false; // ä¸Šä¼ æˆåŠŸï¼Œä¸éœ€è¦ TypingMind å†åŒæ­¥äº†\n          console.log('æˆåŠŸä¸Šä¼ åˆ° Chevereto:', finalImageUrl);\n        } else {\n          // API è¿”å›žäº†æˆåŠŸçŠ¶æ€ç ï¼Œä½†å†…å®¹ç»“æž„ä¸å¯¹\n          console.error('Chevereto API è¿”å›žç»“æž„å¼‚å¸¸:', result);\n          // å›žé€€åˆ° data URL\n        }\n      }\n    } catch (uploadError) {\n      // ç½‘ç»œæˆ–å…¶ä»–å¼‚å¸¸\n      console.error('ä¸Šä¼ åˆ° Chevereto æ—¶å‘ç”Ÿé”™è¯¯:', uploadError);\n      // å›žé€€åˆ° data URL\n    }\n  } else {\n    console.log(\"æœªé…ç½® Chevereto æˆ–ç¼ºå°‘ Keyï¼Œä½¿ç”¨é»˜è®¤ Data URLã€‚\"); // è°ƒè¯•ä¿¡æ¯\n  }\n  // --- ç»“æŸä¿®æ”¹ ---\n\n  // ä½¿ç”¨æœ€ç»ˆç¡®å®šçš„ URL å’ŒåŒæ­¥æ ‡å¿—è¿”å›žç»“æžœ\n  return {\n    cards: [\n      {\n        type: 'image',\n        image: {\n          url: finalImageUrl, // ä½¿ç”¨å¤„ç†åŽçš„ URL\n          alt: prompt.replace(/[\\\[\\\]]/g, ''), // ä¿®æ­£å¹¶è½¬ä¹‰æ­£åˆ™\n          sync: syncImage, // ä½¿ç”¨å¤„ç†åŽçš„åŒæ­¥æ ‡å¿—\n        },\n      },\n    ],\n  };\n}",
    "uuid": "6b22e00a-41ec-4102-9f40-df1b24092c77",
    "emoji": "ðŸ–¼ï¸",
    "title": "GPT Image Editor (with Chevereto)",
    "system": false,
    "syncedAt": null,
    "createdAt": null,
    "deletedAt": null,
    "githubURL": null,
    "mcpDetails": null,
    "openaiSpec": {
        "name": "gpt_image_editor_chevereto",
        "parameters": {
            "type": "object",
            "required": [
                "prompt"
            ],
            "properties": {
                "prompt": {
                    "type": "string",
                    "description": "The description of the image to generate or to edit."
                }
            }
        },
        "description": "Generate a new image or edit an existing image as requested by the user. Optionally uploads to a user-configured Chevereto instance."
    },
    "outputType": "cards",
    "sourceUUID": null,
    "oauthConfig": null,
    "permissions": [
        "read_last_user_message"
    ],
    "preInstalled": false,
    "userSettings": [
        {
            "name": "openaikey",
            "type": "password",
            "label": "OpenAI API Key (Required)",
            "required": true,
            "description": "The images will be generated using this OpenAI API. Get your API key from https://platform.openai.com/account/api-keys",
            "placeholder": "sk-******"
        },
        {
            "name": "base_url",
            "type": "text",
            "label": "API Base URL",
            "description": "Optional. Use a third-party API endpoint instead of the default OpenAI API",
            "placeholder": "https://api.openai.com"
        },
        {
            "name": "resolution",
            "type": "enum",
            "label": "Resolution",
            "values": [
                "auto",
                "1024x1024",
                "1536x1024",
                "1024x1536"
            ],
            "description": "Optional, default: \"auto\""
        },
        {
            "name": "quality",
            "type": "enum",
            "label": "Quality",
            "values": [
                "auto",
                "high",
                "medium",
                "low"
            ],
            "description": "Optional, default: \"auto\""
        },
        {
            "name": "cheveretoUrl",
            "type": "text",
            "label": "Chevereto API ä¸Šä¼  URL (å¯é€‰)",
            "description": "ä½ çš„ Chevereto V1 API ä¸Šä¼ åœ°å€ã€‚å¦‚æžœç•™ç©ºï¼Œå°†ä½¿ç”¨ TypingMind é»˜è®¤å­˜å‚¨ã€‚ä¾‹å¦‚: https://ä½ çš„åŸŸå.com/api/1/upload",
            "placeholder": "https://ä½ çš„åŸŸå.com/api/1/upload",
            "required": false
        },
        {
            "name": "cheveretoApiKey",
            "type": "password",
            "label": "Chevereto API Key (å¯é€‰)",
            "description": "ä½ çš„ Chevereto API v1 Keyã€‚å¦‚æžœæä¾›äº† URL ä½†æœªæä¾› Keyï¼Œä¸Šä¼ ä¼šå¤±è´¥ã€‚",
            "placeholder": "ä½ çš„ Chevereto API Key",
            "required": false
        }
    ],
    "overviewMarkdown": "## GPT Image Editor (with Chevereto Upload)\n\nGenerate or edit an image with OpenAI's GPT Image model.\n\nMake sure youâ€™ve entered your OpenAI API key in settings.\n\n**Optionally**, configure your Chevereto instance URL and API Key in the settings to upload generated images directly to your own storage, bypassing TypingMind's limit.\n\nExample usage:\n\n> Generate a picture of a cat\n\n> [Image Attachment] Add a hat to this cat",
    "authenticationType": "AUTH_TYPE_NONE",
    "implementationType": "javascript",
    "dynamicContextEndpoints": [],
    "sharedOAuthConnectionID": null
}
